<!-- save as admin.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HabitForge — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#F6F8FB;--surface:#fff;--muted:#6b7280;--accent:#2b6ef6;--radius:12px}
  body.dark{--bg:#071226;--muted:#9aa4b2}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:#07122a;padding:12px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:980px;display:flex;flex-direction:column;gap:12px}
  header{display:flex;justify-content:space-between;align-items:center}
  .panel{background:var(--surface);padding:12px;border-radius:12px;border:1px solid rgba(10,20,40,0.04)}
  form{display:flex;flex-direction:column;gap:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select,textarea{padding:10px;border-radius:10px;border:1px solid rgba(10,20,40,0.06);width:100%}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;border:1px solid rgba(10,20,40,0.04)}
  .thumb{width:84px;height:60px;border-radius:8px;object-fit:cover;background:#eef2ff}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(10,20,40,0.06);cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#6a9cff);color:#fff;border:0}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div><strong>Admin</strong><div class="small">Add exercises (supports Drive links)</div></div>
      <div><a class="btn" href="index.html">Back</a></div>
    </header>

    <section class="panel">
      <form id="form">
        <div class="row">
          <input id="name" placeholder="Exercise name" required />
          <select id="type" style="width:180px">
            <option value="workout">Workout</option><option value="diet">Diet</option><option value="martial">Martial</option>
          </select>
        </div>
        <div class="row">
          <select id="category" style="width:220px"></select>
          <input id="image" placeholder="Image / GIF URL (Drive OK)" />
        </div>
        <textarea id="desc" rows="3" placeholder="Description (optional)"></textarea>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button type="button" class="btn" id="reset">Reset</button>
          <button type="submit" class="btn primary">Add Exercise</button>
        </div>
      </form>

      <div class="list" id="list"></div>
    </section>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, doc, setDoc, addDoc, deleteDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAPrqqUbYzcPgFa34tKZvEB9IkT5yReJmw",
  authDomain: "habitforge-185f6.firebaseapp.com",
  projectId: "habitforge-185f6",
  storageBucket: "habitforge-185f6.firebasestorage.app",
  messagingSenderId: "23479259079",
  appId: "1:23479259079:web:3681e77d6684adf636d3e2",
  measurementId: "G-LP0P86N6LN"
};
const app = initializeApp(firebaseConfig);
getAnalytics(app);
const auth = getAuth();
const db = getFirestore();

const $ = (s,r=document) => r.querySelector(s);
const form = $('#form'), nameIn = $('#name'), typeIn = $('#type'), catIn = $('#category'), imageIn = $('#image'), descIn = $('#desc'), listDiv = $('#list'), resetBtn = $('#reset');

const TYPE_CATS = {
  workout:['Biceps','Triceps','Chest','Back','Abs','Legs','Shoulders','Cardio','Full Body','Mobility'],
  diet:['Breakfast','Lunch','Dinner','Snack','Supplements','Hydration'],
  martial:['Striking','Grappling','Forms','Footwork','Conditioning','Drills']
};

function localKey(k,uid='guest'){ return `${k}_${uid}`; }
function uid(){ return auth.currentUser ? auth.currentUser.uid : 'guest'; }
function loadLocal(k){ try{ return JSON.parse(localStorage.getItem(localKey(k, uid())))||[] }catch(e){return []}}
function saveLocal(k,v){ localStorage.setItem(localKey(k, uid()), JSON.stringify(v)); }

function imageCandidates(url){ if(!url) return ['']; const out=[]; if(/^data:|https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(url)) out.push(url); const m=url.match(/\/d\/([a-zA-Z0-9_-]{10,})/); if(m){ out.push(`https://drive.google.com/uc?export=view&id=${m[1]}`); out.push(`https://drive.google.com/thumbnail?id=${m[1]}`)} try{ const u=new URL(url); const id=u.searchParams.get('id'); if(id) out.push(`https://drive.google.com/uc?export=view&id=${id}`)}catch(e){} if(!out.includes(url)) out.push(url); out.push('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="640" height="360"><rect width="100%" height="100%" fill="%23eef2ff"/></svg>'); return out; }

function populateCats(type){
  catIn.innerHTML=''; (TYPE_CATS[type]||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; catIn.appendChild(o); });
}

function renderList(){
  const arr = loadLocal('habitforge_exercises');
  listDiv.innerHTML='';
  if(arr.length===0){ listDiv.innerHTML = '<div class="small">No exercises yet.</div>'; return; }
  arr.forEach(e => {
    const it = document.createElement('div'); it.className='item';
    const img = document.createElement('img'); img.className='thumb';
    const c = imageCandidates(e.image||''); let i=0; img.src=c[i]; img.onerror = ()=>{ i++; if(i<c.length) img.src=c[i]; };
    const info = document.createElement('div'); info.style.flex='1'; info.innerHTML = `<div style="font-weight:700">${e.name}</div><div class="small">${e.type} • ${e.category}</div><div class="small">${e.desc||''}</div>`;
    const del = document.createElement('button'); del.className='btn'; del.textContent='Delete';
    del.addEventListener('click', async ()=>{
      if(!confirm('Delete this exercise?')) return;
      // remove local
      const newArr = loadLocal('habitforge_exercises').filter(x=>x.id !== e.id); saveLocal('habitforge_exercises', newArr);
      // remove remote if signed in
      if(auth.currentUser){ try{ await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'exercises', e.id)); }catch(err){ console.warn('delete remote failed', err); } }
      renderList();
    });
    it.appendChild(img); it.appendChild(info); it.appendChild(del); listDiv.appendChild(it);
  });
}

form.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const name = nameIn.value.trim(); const type = typeIn.value; const category = catIn.value || (TYPE_CATS[type]||[])[0] || 'General';
  const image = imageIn.value.trim(); const desc = descIn.value.trim();
  if(!name) return alert('Name required');
  const obj = { id: 'ex_'+Date.now()+'_'+Math.floor(Math.random()*9999), name, type, category, image, desc, createdAt: Date.now() };
  // local add
  const arr = loadLocal('habitforge_exercises'); arr.unshift(obj); saveLocal('habitforge_exercises', arr);
  // remote add if signed in
  if(auth.currentUser){
    try { await setDoc(doc(db, 'users', auth.currentUser.uid, 'exercises', obj.id), {...obj, uid:auth.currentUser.uid}); } catch(err){ console.warn('remote add failed', err); }
  }
  form.reset(); populateCats(typeIn.value); renderList(); alert('Added');
});

resetBtn.addEventListener('click', ()=>{ form.reset(); populateCats(typeIn.value); });

onAuthStateChanged(auth, user => {
  if(user){
    // fetch remote exercises into local
    (async ()=>{
      try {
        const snap = await getDocs(collection(db, 'users', user.uid, 'exercises'));
        const arr = snap.docs.map(d=>d.data());
        saveLocal('habitforge_exercises', arr);
        renderList();
      } catch(e){ console.warn('fetch ex failed', e); renderList(); }
    })();
  } else renderList();
});

// init
populateCats(typeIn.value);
renderList();
</script>
</body>
</html>
