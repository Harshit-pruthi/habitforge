<!-- save as index.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HabitForge ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  /* Mobile-first professional styles (compact, readable) */
  :root{
    --bg:#F5F7FB; --surface:#ffffff; --muted:#6b7280; --text:#07122a;
    --accent1:#2b6ef6; --accent2:#6a9cff; --success:#16a34a; --radius:12px;
    --maxw:980px;
  }
  body.dark{ --bg:#071226; --surface:#071226; --muted:#9aa4b2; --text:#e6eef9; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;padding:12px;display:flex;justify-content:center}
  .app{width:100%;max-width:var(--maxw);display:flex;flex-direction:column;gap:12px}
  header.top{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;color:white;font-weight:700}
  .greet{display:flex;flex-direction:column}
  .greet h1{margin:0;font-size:17px}
  .greet p{margin:2px 0 0 0;color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{border-radius:10px;padding:8px 10px;border:1px solid rgba(10,20,40,0.06);background:var(--surface);font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:0}
  .avatar{width:36px;height:36px;border-radius:999px;overflow:hidden;display:inline-block}
  .avatar img{width:100%;height:100%;object-fit:cover}

  /* module selector */
  .modules{display:flex;gap:8px;overflow:auto;padding:8px 0}
  .module{min-width:120px;padding:10px;border-radius:12px;background:var(--surface);display:flex;gap:10px;align-items:center;border:1px solid rgba(10,20,40,0.04);cursor:pointer}
  .module.active{box-shadow:0 10px 30px rgba(43,110,246,0.12);transform:translateY(-2px)}

  /* grid: single column on phones, 2 columns on wider */
  .panel{background:var(--surface);padding:12px;border-radius:12px;border:1px solid rgba(10,20,40,0.04)}
  .cards{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media(min-width:640px){ .cards{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:1000px){ .cards{grid-template-columns:repeat(3,1fr)} }

  .card{border-radius:12px;overflow:hidden;border:1px solid rgba(10,20,40,0.04);display:flex;flex-direction:column;background:linear-gradient(180deg,#fff,#fbfdff);min-height:160px;cursor:pointer}
  .thumb{aspect-ratio:16/9;width:100%;background:#eef2ff;position:relative}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .thumb .label{position:absolute;left:8px;top:8px;background:rgba(0,0,0,0.6);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px}
  .body{padding:10px;display:flex;flex-direction:column;gap:8px;flex:1}
  .title{font-weight:700;margin:0}
  .meta{display:flex;justify-content:space-between;align-items:center;gap:8px;color:var(--muted);font-size:13px}
  .done-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(22,163,74,0.12);opacity:0;transition:opacity .12s}
  .card.completed .done-overlay{opacity:1}
  .card.completed .title{text-decoration:line-through}

  footer{display:flex;justify-content:space-between;color:var(--muted);font-size:13px;padding:6px 0}

  /* small helpers */
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .icon{font-size:18px}

  /* input adaptive */
  input[type="text"], select{padding:10px;border-radius:10px;border:1px solid rgba(10,20,40,0.06);width:100%}

  /* tiny bottom nav for phones */
  .bottomnav{display:flex;gap:8px;justify-content:space-around;padding:10px 6px;background:var(--surface);border-radius:12px;border:1px solid rgba(10,20,40,0.04)}
</style>
</head>
<body>
  <div class="app" id="app">
    <header class="top">
      <div class="brand">
        <div class="logo" aria-hidden>HF</div>
        <div class="greet">
          <h1 id="greet">Hello, Guest</h1>
          <p id="subg" class="small">Sign in to sync your plans</p>
        </div>
      </div>
      <div class="controls" id="topControls">
        <button class="btn" id="createPlanBtn">Create Plan</button>
        <button class="btn" id="adminBtn">Admin</button>
        <div id="authArea"></div>
      </div>
    </header>

    <!-- module selector -->
    <section class="panel" aria-label="Modules">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Modules</strong><div class="small muted">Tap to open</div></div>
        <div class="small muted" id="todayLabel">‚Äî</div>
      </div>

      <div class="modules" id="modules">
        <div class="module" data-module="workout">üèãÔ∏è‚Äç‚ôÇÔ∏è <div style="font-weight:700;margin-left:6px">Workout</div></div>
        <div class="module" data-module="diet">üçΩÔ∏è <div style="font-weight:700;margin-left:6px">Diet</div></div>
        <div class="module" data-module="martial">ü•ã <div style="font-weight:700;margin-left:6px">Martial Arts</div></div>
      </div>
    </section>

    <!-- cards -->
    <section class="panel" aria-label="Today's plan">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Today's Plan</strong><div class="small muted" id="planCount">‚Äî</div></div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="refreshBtn">Refresh</button>
          <button class="btn" id="themeBtn">Theme</button>
        </div>
      </div>

      <div class="cards" id="cards" aria-live="polite"></div>
    </section>

    <footer>
      <div class="small muted">HabitForge ‚Äî plan, track, repeat</div>
      <div class="small muted">Local ‚Ä¢ Google Sign-In supported</div>
    </footer>

    <nav class="bottomnav" style="margin-top:8px">
      <button class="btn" id="navHome">Home</button>
      <button class="btn" id="navCreate">Create</button>
      <button class="btn" id="navAdmin">Admin</button>
    </nav>
  </div>

  <!-- Firebase initialisation + Auth -->
  <script type="module">
  // Firebase imports and config (you supplied)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAPrqqUbYzcPgFa34tKZvEB9IkT5yReJmw",
    authDomain: "habitforge-185f6.firebaseapp.com",
    projectId: "habitforge-185f6",
    storageBucket: "habitforge-185f6.firebasestorage.app",
    messagingSenderId: "23479259079",
    appId: "1:23479259079:web:3681e77d6684adf636d3e2",
    measurementId: "G-LP0P86N6LN"
  };
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth();

  /* ---------- namespacing helpers ---------- */
  const localKey = (key, uid) => `${key}_${uid || 'guest'}`;

  // storage helpers (per-user when signed in)
  function loadRaw(k, uid) {
    try { return JSON.parse(localStorage.getItem(localKey(k, uid))) || []; } catch(e){ return []; }
  }
  function saveRaw(k, v, uid) { localStorage.setItem(localKey(k, uid), JSON.stringify(v)); }

  /* ---------- utilities ---------- */
  function todayIndex(){ const d = new Date(); return (d.getDay() + 6) % 7; } // Mon=0
  function dayName(i){ return ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i] || ''; }
  function todayISO(d=new Date()){ return d.toISOString().slice(0,10); }

  function imageCandidates(url){
    if(!url) return [''];
    url = url.trim();
    const c = [];
    if(/^data:|https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(url)) c.push(url);
    const m = url.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
    if(m){ c.push(`https://drive.google.com/uc?export=view&id=${m[1]}`); c.push(`https://drive.google.com/thumbnail?id=${m[1]}`); }
    try { const u = new URL(url); const id = u.searchParams.get('id'); if(id) { c.push(`https://drive.google.com/uc?export=view&id=${id}`); } } catch(e){}
    if(!c.includes(url)) c.push(url);
    c.push('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="640" height="360"><rect width="100%" height="100%" fill="%23eef2ff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%236b7280" font-family="Arial" font-size="18">No Image</text></svg>');
    return c;
  }

  /* ---------- UI elements ---------- */
  const greetEl = document.getElementById('greet');
  const subg = document.getElementById('subg');
  const authArea = document.getElementById('authArea');
  const modulesEls = document.querySelectorAll('.module');
  const cardsEl = document.getElementById('cards');
  const planCountEl = document.getElementById('planCount');
  const todayLabel = document.getElementById('todayLabel');

  const createPlanBtn = document.getElementById('createPlanBtn');
  const adminBtn = document.getElementById('adminBtn');
  const navCreate = document.getElementById('navCreate');
  const navAdmin = document.getElementById('navAdmin');
  const refreshBtn = document.getElementById('refreshBtn');
  const themeBtn = document.getElementById('themeBtn');
  const themePrefKey = 'habitforge_theme';
  let currentUid = null;
  let currentUser = null;
  let activeModule = 'workout';

  /* ---------- routing helpers (open pages) ---------- */
  createPlanBtn.addEventListener('click', ()=> location.href = 'create-plan.html');
  adminBtn.addEventListener('click', ()=> location.href = 'admin.html');
  navCreate.addEventListener('click', ()=> location.href = 'create-plan.html');
  navAdmin.addEventListener('click', ()=> location.href = 'admin.html');

  /* ---------- auth UI and handlers ---------- */
  function renderAuthArea(user){
    authArea.innerHTML = '';
    if(user){
      currentUid = user.uid;
      currentUser = user;
      const avatar = document.createElement('div'); avatar.className='avatar'; const img = document.createElement('img'); img.src = user.photoURL || ''; avatar.appendChild(img);
      const nameBtn = document.createElement('button'); nameBtn.className='btn'; nameBtn.textContent = user.displayName || 'User';
      const outBtn = document.createElement('button'); outBtn.className='btn'; outBtn.textContent='Sign out';
      outBtn.addEventListener('click', ()=> signOut(auth).then(()=>{/*signed out*/}).catch(()=>{}));
      authArea.appendChild(avatar); authArea.appendChild(nameBtn); authArea.appendChild(outBtn);
      greetEl.textContent = `Hello, ${user.displayName || 'User'}`;
      subg.textContent = 'Signed in';
    } else {
      currentUid = null;
      currentUser = null;
      const signBtn = document.createElement('button'); signBtn.className='btn primary'; signBtn.textContent='Sign in with Google';
      signBtn.addEventListener('click', googleSignIn);
      authArea.appendChild(signBtn);
      greetEl.textContent = 'Hello, Guest';
      subg.textContent = 'Sign in to sync your plans';
    }
    renderGrid(); // refresh with user namespace
  }

  const provider = new GoogleAuthProvider();
  async function googleSignIn(){
    try {
      await signInWithPopup(auth, provider);
      // onAuthStateChanged will handle UI update
    } catch(err){
      alert('Sign-in failed: ' + (err.message || err));
    }
  }

  onAuthStateChanged(auth, (user) => {
    renderAuthArea(user);
  });

  /* ---------- theme ---------- */
  function applyTheme(t){
    if(!t) t = localStorage.getItem(themePrefKey) || 'light';
    if(t === 'dark') document.body.classList.add('dark'); else document.body.classList.remove('dark');
    localStorage.setItem(themePrefKey, t);
  }
  themeBtn.addEventListener('click', ()=>{
    const now = document.body.classList.contains('dark') ? 'light' : 'dark';
    applyTheme(now);
  });
  applyTheme(localStorage.getItem(themePrefKey));

  /* ---------- data layer helpers (per-user when signed in) ---------- */
  function key(k){ return localKey(k, currentUid); }
  function localKey(k, uid){ return `${k}_${uid || 'guest'}`; }

  function loadArr(k){ try { return JSON.parse(localStorage.getItem(key(k))) || []; } catch(e){ return []; } }
  function saveArr(k, arr){ localStorage.setItem(key(k), JSON.stringify(arr)); }

  // convenient getters
  function getExercises(){ return loadArr('habitforge_exercises'); }
  function getPlans(){ return loadArr('habitforge_plans'); }

  /* ---------- render grid (today's plans filtered by module and day) ---------- */
  function renderGrid(){
    cardsEl.innerHTML = '';
    const plans = getPlans();
    const exercises = getExercises();
    const todayIdx = todayIndex();
    todayLabel.textContent = `${dayName(todayIdx)} ‚Ä¢ ${new Date().toLocaleDateString()}`;

    const todayPlans = plans.filter(p => {
      const t = (p.exerciseSnapshot && p.exerciseSnapshot.type) || '';
      return t === activeModule && Array.isArray(p.days) && p.days.includes(todayIdx);
    });

    planCountEl.textContent = `${todayPlans.length} item${todayPlans.length !== 1 ? 's' : ''}`;

    if(todayPlans.length === 0){
      const empty = document.createElement('div'); empty.className='small muted'; empty.textContent = 'No items planned for this module today. Use Create Plan.';
      cardsEl.appendChild(empty); return;
    }

    // done map structure: { planId: { 'YYYY-MM-DD': true } }
    const doneMap = JSON.parse(localStorage.getItem(localKey('habitforge_done', currentUid)) || '{}');

    todayPlans.forEach(p => {
      const ex = p.exerciseSnapshot || exercises.find(e => e.id === p.exerciseId) || {};
      const card = document.createElement('article'); card.className='card';
      // completed?
      const today = todayISO();
      const completed = !!(doneMap[p.id] && doneMap[p.id][today]);
      if(completed) card.classList.add('completed');

      // thumb
      const thumb = document.createElement('div'); thumb.className='thumb';
      const img = document.createElement('img'); img.alt = ex.name || '';
      const cands = imageCandidates(ex.image || '');
      let i = 0; img.src = cands[i];
      img.onerror = ()=> { i++; if(i < cands.length) img.src = cands[i]; };
      thumb.appendChild(img);
      const label = document.createElement('div'); label.className='label'; label.textContent = ex.category || (ex.type || activeModule); thumb.appendChild(label);
      const doneOverlay = document.createElement('div'); doneOverlay.className='done-overlay'; doneOverlay.innerHTML = '<div style="padding:10px;border-radius:999px;background:#16a34a;color:#fff;font-weight:800">‚úì Done</div>'; thumb.appendChild(doneOverlay);

      // body
      const body = document.createElement('div'); body.className='body';
      const title = document.createElement('div'); title.className='title'; title.textContent = ex.name || 'Unnamed';
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<div class="small muted">${ex.type || activeModule}</div><div class="small muted">${(p.days || []).map(d=>dayName(d)).join(', ')}</div>`;
      body.appendChild(title); body.appendChild(meta);

      // footer actions
      const footer = document.createElement('div'); footer.className='card-foot';
      const removeBtn = document.createElement('button'); removeBtn.className='btn'; removeBtn.textContent='Remove';
      removeBtn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        if(!confirm('Remove from plan?')) return;
        const newPlans = getPlans().filter(pp => pp.id !== p.id);
        saveArr('habitforge_plans', newPlans);
        renderGrid();
      });
      footer.appendChild(removeBtn);

      card.appendChild(thumb); card.appendChild(body); card.appendChild(footer);

      card.addEventListener('click', ()=>{
        const dm = JSON.parse(localStorage.getItem(localKey('habitforge_done', currentUid)) || '{}');
        dm[p.id] = dm[p.id] || {};
        if(dm[p.id][today]) delete dm[p.id][today]; else dm[p.id][today] = true;
        if(dm[p.id] && Object.keys(dm[p.id]).length === 0) delete dm[p.id];
        localStorage.setItem(localKey('habitforge_done', currentUid), JSON.stringify(dm));
        card.classList.toggle('completed');
      });

      cardsEl.appendChild(card);
    });
  }

  /* ---------- UI wiring ---------- */
  modulesEls.forEach(el => el.addEventListener('click', ()=>{
    modulesEls.forEach(x => x.classList.remove('active'));
    el.classList.add('active');
    activeModule = el.dataset.module;
    renderGrid();
  }));

  refreshBtn.addEventListener('click', renderGrid);

  // set initial active module (from last used stats or default)
  (function initModule(){
    const stats = JSON.parse(localStorage.getItem(localKey('habitforge_stats', currentUid)) || '{}');
    const last = stats.lastModule || 'workout';
    const el = Array.from(modulesEls).find(m => m.dataset.module === last) || modulesEls[0];
    el.classList.add('active'); activeModule = el.dataset.module;
  })();

  /* ---------- navigation: open create-plan/admin pages (they will share auth) ---------- */
  // handled above with link buttons

  /* ---------- initial render and auth area update ---------- */
  renderAuthArea(null); // shows sign-in button while waiting
  renderGrid();

  // update auth area when auth changes is handled by onAuthStateChanged above (renderAuthArea)
  </script>
</body>
</html>
