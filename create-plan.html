<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>HabitForge — Create Plan</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --muted:#6b7280;
    --accent-from:#2b6ef6; --accent-to:#6a9cff; --shadow:0 14px 36px rgba(12,18,36,0.06);
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;background:var(--bg);color:#07122a;padding:16px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:1100px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent-from),var(--accent-to));display:grid;place-items:center;color:white;font-weight:700}
  h1{margin:0;font-size:18px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(90deg,var(--accent-from),var(--accent-to));color:white}
  .btn.ghost{background:transparent;border:1px solid rgba(7,18,42,0.06)}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;border:1px solid rgba(7,18,42,0.04)}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:12px}
  .small{font-size:13px;color:var(--muted)}
  .module-tabs{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
  .tab{padding:10px 12px;border-radius:10px;cursor:pointer;border:1px solid rgba(7,18,42,0.03);background:#fff;min-width:110px;text-align:center}
  .tab.active{box-shadow:0 8px 18px rgba(7,18,42,0.06);background:linear-gradient(180deg,#fff,#fbfdff)}
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid rgba(7,18,42,0.04);vertical-align:middle}
  th{background:transparent;text-align:left;font-weight:600;font-size:13px}
  img.thumb{width:60px;height:40px;object-fit:cover;border-radius:6px}
  .days{display:flex;gap:6px;flex-wrap:wrap}
  .daychk{display:inline-flex;align-items:center;gap:6px;padding:6px;border-radius:8px;border:1px solid rgba(7,18,42,0.04);font-size:12px;cursor:pointer}
  .plan-list{max-height:320px;overflow:auto;margin-top:8px}
  .plan-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid rgba(7,18,42,0.03);margin-bottom:8px;background:linear-gradient(180deg,#fff,#fbfdff)}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} img.thumb{width:48px;height:36px} .tab{min-width:90px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">HF</div>
        <div>
          <h1>Create Plan</h1>
          <div class="small">Pick a module, choose exercises, select days and add to the weekly plan.</div>
        </div>
      </div>
      <div class="controls">
        <a class="btn ghost" href="index.html">← Dashboard</a>
        <a class="btn" href="admin.html">Open Admin</a>
        <button id="exportBtn" class="btn ghost">Export Data</button>
        <button id="clearBtn" class="btn ghost">Clear All</button>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <div>
          <div class="module-tabs" id="moduleTabs" role="tablist" aria-label="Modules">
            <div class="tab active" data-module="workout" role="tab" tabindex="0">Workout</div>
            <div class="tab" data-module="diet" role="tab" tabindex="0">Diet</div>
            <div class="tab" data-module="martial" role="tab" tabindex="0">Martial Arts</div>
          </div>

          <div class="filters">
            <label class="small">Category:
              <select id="categoryFilter">
                <option value="all">All</option>
              </select>
            </label>

            <label class="small">Search:
              <input id="searchInput" type="search" placeholder="Exercise name..." style="padding:8px;border-radius:8px;border:1px solid rgba(7,18,42,0.06)">
            </label>
          </div>

          <div style="overflow:auto">
            <table id="exercisesTable" aria-live="polite">
              <thead>
                <tr>
                  <th style="width:110px">Exercise</th>
                  <th>Category</th>
                  <th style="width:220px">Days</th>
                  <th style="width:120px">Action</th>
                </tr>
              </thead>
              <tbody id="exTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Weekly Plan</h3>
          <div class="small" id="planCount">0 items</div>
        </div>

        <div class="small" style="margin:8px 0 12px 0">Shows items you've added to the weekly plan. You can remove items here.</div>

        <div class="plan-list" id="planList" aria-live="polite"></div>
      </aside>
    </main>
  </div>

<script>
/* normalize drive links */
function normalizeImageUrl(url){
  if(!url) return '';
  url = url.trim();
  const dmatch = url.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
  if(dmatch) return `https://drive.google.com/uc?export=view&id=${dmatch[1]}`;
  const idParam = (new URLSearchParams(url.split('?')[1] || '')).get('id');
  if(idParam) return `https://drive.google.com/uc?export=view&id=${idParam}`;
  return url;
}

/* storage functions */
function loadExercises(){ return JSON.parse(localStorage.getItem('habitforge_exercises') || '[]'); }
function saveExercises(arr){ localStorage.setItem('habitforge_exercises', JSON.stringify(arr)); }
function loadPlans(){ return JSON.parse(localStorage.getItem('habitforge_plans') || '[]'); }
function savePlans(arr){ localStorage.setItem('habitforge_plans', JSON.stringify(arr)); }

/* categories */
const CATEGORIES = {
  workout: ['All','Biceps','Triceps','Chest','Back','Abs','Legs','Shoulders','Cardio','Full Body','Mobility'],
  diet: ['All','Breakfast','Lunch','Dinner','Snack','Supplements','Hydration'],
  martial: ['All','Striking','Grappling','Forms','Footwork','Conditioning','Drills'],
};

const tabs = document.getElementById('moduleTabs');
const categoryFilter = document.getElementById('categoryFilter');
const exTableBody = document.getElementById('exTableBody');
const planList = document.getElementById('planList');
const planCount = document.getElementById('planCount');
const searchInput = document.getElementById('searchInput');

let activeModule = 'workout';
let exercises = loadExercises();
let plans = loadPlans();

function populateCategoriesForModule(module){
  categoryFilter.innerHTML='';
  (CATEGORIES[module] || ['All']).forEach(c=>{
    const opt=document.createElement('option'); opt.value=c.toLowerCase(); opt.textContent=c; categoryFilter.appendChild(opt);
  });
  categoryFilter.value='all';
}

function renderExercises(){
  exercises = loadExercises();
  exTableBody.innerHTML='';
  const search = searchInput.value.trim().toLowerCase();
  const catFilter = categoryFilter.value;
  const filtered = exercises.filter(e=> e.type === activeModule)
    .filter(e => (catFilter === 'all' || e.category.toLowerCase() === catFilter))
    .filter(e => e.name.toLowerCase().includes(search));

  if(filtered.length === 0){
    exTableBody.innerHTML = `<tr><td colspan="4" class="small">No exercises. Use Admin to add exercises.</td></tr>`;
    return;
  }

  filtered.forEach(e=>{
    const tr=document.createElement('tr');
    const tdEx=document.createElement('td');
    const wrapper=document.createElement('div'); wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.style.gap='10px';
    const img=document.createElement('img'); img.className='thumb'; img.alt=e.name;
    img.src = normalizeImageUrl(e.image || '');
    img.onerror = ()=> img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="80"><rect width="100%" height="100%" fill="%23eef2ff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%236b7280" font-family="Arial" font-size="12">No Image</text></svg>';
    const nameDiv=document.createElement('div'); nameDiv.innerHTML = `<div style="font-weight:700">${e.name}</div><div class="small" style="margin-top:4px">${e.type} • ${e.category}</div>`;
    wrapper.appendChild(img); wrapper.appendChild(nameDiv); tdEx.appendChild(wrapper);

    const tdCat=document.createElement('td'); tdCat.textContent = e.category;

    const tdDays=document.createElement('td'); const daysWrapper=document.createElement('div'); daysWrapper.className='days';
    const DAYNAMES=['Mon','Tue','Wed','Thu','Fri','Sat','Sun']; const dayChecks=[];
    DAYNAMES.forEach((d,idx)=>{ const lab=document.createElement('label'); lab.className='daychk'; const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.day=idx; cb.style.width='16px'; cb.style.height='16px'; lab.appendChild(cb); lab.appendChild(document.createElement('span')).textContent = d; daysWrapper.appendChild(lab); dayChecks.push(cb); });

    tdDays.appendChild(daysWrapper);

    const tdAction=document.createElement('td'); const addBtn=document.createElement('button'); addBtn.className='btn primary'; addBtn.textContent='Add to Plan';
    addBtn.addEventListener('click', ()=>{
      const days = dayChecks.map(cb => cb.checked ? Number(cb.dataset.day) : null).filter(x=>x!==null);
      if(days.length===0){ alert('Select at least one day'); return; }
      addToPlan(e.id, days);
    });
    tdAction.appendChild(addBtn);

    tr.appendChild(tdEx); tr.appendChild(tdCat); tr.appendChild(tdDays); tr.appendChild(tdAction);
    exTableBody.appendChild(tr);
  });
}

function addToPlan(exerciseId, days){
  exercises = loadExercises();
  const exercise = exercises.find(x => x.id === exerciseId);
  if(!exercise){ alert('Exercise not found'); return; }
  plans = loadPlans();
  const newPlanEntry = { id:'p_'+Date.now()+'_'+Math.floor(Math.random()*9999), exerciseId:exercise.id, exerciseSnapshot:{...exercise}, days:days.slice().sort((a,b)=>a-b), addedAt:Date.now() };
  plans.push(newPlanEntry); savePlans(plans);
  renderPlans(); alert('Added to plan ✓');
}

function renderPlans(){
  plans = loadPlans();
  planList.innerHTML='';
  if(plans.length===0){ planList.innerHTML = '<div class="small">No items in your weekly plan yet.</div>'; planCount.textContent='0 items'; return; }
  const dayNames=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  plans.forEach(pl=>{
    const div=document.createElement('div'); div.className='plan-item';
    const img=document.createElement('img'); img.className='thumb'; img.src = normalizeImageUrl(pl.exerciseSnapshot.image || '');
    img.onerror = ()=> img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="80"><rect width="100%" height="100%" fill="%23eef2ff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%236b7280" font-family="Arial" font-size="12">No Image</text></svg>';
    const info=document.createElement('div'); info.style.flex='1'; info.innerHTML = `<div style="font-weight:700">${pl.exerciseSnapshot.name}</div><div class="small">${pl.exerciseSnapshot.category} • ${pl.exerciseSnapshot.type}</div><div class="small" style="margin-top:6px">Days: ${pl.days.map(d=>dayNames[d]).join(', ')}</div>`;
    const remove=document.createElement('button'); remove.className='btn ghost'; remove.textContent='Remove';
    remove.addEventListener('click', ()=>{ if(confirm('Remove this item from plan?')){ plans = plans.filter(x=>x.id!==pl.id); savePlans(plans); renderPlans(); }});
    div.appendChild(img); div.appendChild(info); div.appendChild(remove);
    planList.appendChild(div);
  });
  planCount.textContent = plans.length + ' items';
}

/* tabs + filters */
function setActiveModule(mod){
  activeModule = mod;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.module === mod));
  populateCategoriesForModule(mod);
  renderExercises();
}

document.querySelectorAll('.tab').forEach(t => { t.addEventListener('click', ()=> setActiveModule(t.dataset.module)); t.addEventListener('keydown', (e)=> { if(e.key==='Enter') setActiveModule(t.dataset.module); }); });
categoryFilter.addEventListener('change', renderExercises);
searchInput.addEventListener('input', ()=> setTimeout(renderExercises, 120));

/* export & clear */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = {exercises: loadExercises(), plans: loadPlans()};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='habitforge-export.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('Clear all exercises and plans?')){
    localStorage.removeItem('habitforge_exercises'); localStorage.removeItem('habitforge_plans'); exercises=[]; plans=[]; renderExercises(); renderPlans();
  }
});

/* seed minimal data if empty */
(function seedIfEmpty(){
  exercises = loadExercises();
  if(exercises.length === 0 && !localStorage.getItem('habitforge_seeded')){
    const seed=[
      { id:'ex_bench_1', name:'Push-ups', type:'workout', category:'Chest', image:'' },
      { id:'ex_squat_1', name:'Squats', type:'workout', category:'Legs', image:'' },
      { id:'ex_bicep_1', name:'Biceps Curl', type:'workout', category:'Biceps', image:'' },
      { id:'ex_meal_1', name:'Protein Shake', type:'diet', category:'Snack', image:'' },
      { id:'ex_roll_1', name:'Shadow Boxing', type:'martial', category:'Striking', image:'' }
    ];
    saveExercises(seed);
    localStorage.setItem('habitforge_seeded','1');
  }
  exercises = loadExercises();
})();

/* initialize UI */
populateCategoriesForModule(activeModule);
renderExercises();
renderPlans();
</script>
</body>
</html>
