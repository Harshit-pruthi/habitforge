<!-- save as create-plan.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HabitForge â€” Create Plan</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#F5F7FB;--surface:#fff;--muted:#6b7280;--text:#07122a;--accent:#2b6ef6;--radius:12px}
  body.dark{--bg:#071226;--surface:#0b1522;--muted:#9aa4b2}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);padding:12px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:980px;display:flex;flex-direction:column;gap:12px}
  header{display:flex;justify-content:space-between;align-items:center}
  .panel{background:var(--surface);padding:12px;border-radius:12px;border:1px solid rgba(10,20,40,0.04)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  select,input{padding:10px;border-radius:10px;border:1px solid rgba(10,20,40,0.06)}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .ex{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;border:1px solid rgba(10,20,40,0.04)}
  .thumb{width:96px;height:64px;background:#eef2ff;border-radius:8px;object-fit:cover}
  .days{display:flex;gap:6px;flex-wrap:wrap}
  .day{padding:6px 8px;border-radius:8px;border:1px solid rgba(10,20,40,0.04);font-weight:700;cursor:pointer}
  .day.selected{background:linear-gradient(90deg,var(--accent),#6a9cff);color:#fff;border:0}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(10,20,40,0.06);background:var(--surface);font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#6a9cff);color:#fff;border:0}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div><strong>Create Plan</strong><div class="small">Pick exercises and select days</div></div>
      <div style="display:flex;gap:8px"><a class="btn" href="index.html">Back</a></div>
    </header>

    <section class="panel">
      <div class="row">
        <select id="moduleSelect"><option value="workout">Workout</option><option value="diet">Diet</option><option value="martial">Martial Arts</option></select>
        <input id="search" placeholder="Search exercise name" style="flex:1" />
        <button class="btn" id="btnReload">Reload</button>
      </div>

      <div class="list" id="exList"></div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button class="btn" id="btnExport">Export</button>
        <button class="btn primary" id="btnDone">Done</button>
      </div>
    </section>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAPrqqUbYzcPgFa34tKZvEB9IkT5yReJmw",
  authDomain: "habitforge-185f6.firebaseapp.com",
  projectId: "habitforge-185f6",
  storageBucket: "habitforge-185f6.firebasestorage.app",
  messagingSenderId: "23479259079",
  appId: "1:23479259079:web:3681e77d6684adf636d3e2",
  measurementId: "G-LP0P86N6LN"
};
const app = initializeApp(firebaseConfig);
getAnalytics(app);
const auth = getAuth();
const db = getFirestore();

const $ = (s, r=document) => r.querySelector(s);
const moduleSelect = $('#moduleSelect'), search = $('#search'), exList = $('#exList'), btnReload = $('#btnReload');
const btnExport = $('#btnExport'), btnDone = $('#btnDone');

function localKey(k, uid='guest'){ return `${k}_${uid}`; }
function uid(){ return auth.currentUser ? auth.currentUser.uid : 'guest'; }
function loadLocal(k){ try{return JSON.parse(localStorage.getItem(localKey(k, uid())))||[];}catch(e){return []} }
function saveLocal(k,v){ localStorage.setItem(localKey(k, uid()), JSON.stringify(v)); }

function imageCandidates(url){
  if(!url) return [''];
  const out=[];
  if(/^data:|https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(url)) out.push(url);
  const m = url.match(/\/d\/([a-zA-Z0-9_-]{10,})/); if(m){ out.push(`https://drive.google.com/uc?export=view&id=${m[1]}`); out.push(`https://drive.google.com/thumbnail?id=${m[1]}`); }
  try{ const u = new URL(url); const id = u.searchParams.get('id'); if(id) out.push(`https://drive.google.com/uc?export=view&id=${id}`); }catch(e){}
  if(!out.includes(url)) out.push(url);
  out.push('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="640" height="360"><rect width="100%" height="100%" fill="%23eef2ff"/></svg>');
  return out;
}

function renderExercises(){
  exList.innerHTML = '';
  const exs = loadLocal('habitforge_exercises');
  const q = (search.value||'').toLowerCase();
  const mod = moduleSelect.value;
  const filtered = exs.filter(e => e.type === mod && e.name.toLowerCase().includes(q));
  if(filtered.length === 0){ exList.innerHTML = '<div class="small">No exercises. Use Admin to add.</div>'; return; }
  filtered.forEach(e => {
    const row = document.createElement('div'); row.className='ex';
    const img = document.createElement('img'); img.className='thumb';
    const c = imageCandidates(e.image||''); let i=0; img.src=c[i]; img.onerror = ()=>{ i++; if(i<c.length) img.src=c[i]; };
    const info = document.createElement('div'); info.style.flex='1'; info.innerHTML = `<div style="font-weight:700">${e.name}</div><div class="small">${e.category}</div>`;
    const days = document.createElement('div'); days.className='days';
    const dayButtons = [];
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach((d,idx)=>{
      const b = document.createElement('button'); b.className='day'; b.textContent = d; b.dataset.day = idx;
      b.addEventListener('click', ()=> b.classList.toggle('selected'));
      days.appendChild(b); dayButtons.push(b);
    });
    const addBtn = document.createElement('button'); addBtn.className='btn primary'; addBtn.textContent='Add';
    addBtn.addEventListener('click', async ()=> {
      const sel = dayButtons.filter(b=>b.classList.contains('selected')).map(b=>Number(b.dataset.day));
      if(sel.length===0) return alert('Select at least one day');
      const plan = { id: 'p_'+Date.now()+'_'+Math.floor(Math.random()*9999), exerciseId: e.id, exerciseSnapshot: {...e}, days: sel.sort((a,b)=>a-b), addedAt: Date.now() };
      // Save locally
      const localPlans = loadLocal('habitforge_plans'); localPlans.push(plan); saveLocal('habitforge_plans', localPlans);
      // push remote if signed in
      if(auth.currentUser){
        try {
          await setDoc(doc(db, 'users', auth.currentUser.uid, 'plans', plan.id), {...plan, uid:auth.currentUser.uid, updatedAt:Date.now()});
        } catch(err){ console.warn('create-plan setDoc failed', err); }
      }
      alert('Added to plan');
    });

    row.appendChild(img); row.appendChild(info); row.appendChild(days); row.appendChild(addBtn);
    exList.appendChild(row);
  });
}

moduleSelect.addEventListener('change', renderExercises);
search.addEventListener('input', ()=> setTimeout(renderExercises, 150));
btnReload.addEventListener('click', renderExercises);

btnExport.addEventListener('click', ()=>{
  const data = { exercises: loadLocal('habitforge_exercises'), plans: loadLocal('habitforge_plans') };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'habitforge-export.json'; a.click(); URL.revokeObjectURL(url);
});

btnDone.addEventListener('click', ()=> location.href = 'index.html');

// keep local copies in sync with Firestore when auth changes
onAuthStateChanged(auth, async user => {
  if(user){
    // fetch exercises & plans into local storage
    try {
      const exSnap = await getDocs(collection(db, 'users', user.uid, 'exercises'));
      const plansSnap = await getDocs(collection(db, 'users', user.uid, 'plans'));
      const exercises = exSnap.docs.map(d => d.data());
      const plans = plansSnap.docs.map(d => d.data());
      saveLocal('habitforge_exercises', exercises);
      saveLocal('habitforge_plans', plans);
    } catch(e){ console.warn('sync failed', e); }
  }
  renderExercises();
});

// initial render
renderExercises();
</script>
</body>
</html>
